#!/bin/bash
# Pre-commit hook for Environmental Bowtie Risk Analysis Application
# Version: 5.5.3
# Runs code quality checks before allowing commits

echo "üîç Running pre-commit checks..."

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track overall success
CHECKS_PASSED=true

# =============================================================================
# 1. CHECK FOR STAGED R FILES
# =============================================================================
STAGED_R_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.[rR]$' || true)

if [ -z "$STAGED_R_FILES" ]; then
  echo "‚ÑπÔ∏è  No R files staged, skipping R-specific checks"
else
  echo "üìã Found $(echo "$STAGED_R_FILES" | wc -l) staged R file(s)"

  # =============================================================================
  # 2. RUN LINTR ON STAGED R FILES
  # =============================================================================
  echo ""
  echo "üé® Running lintr on staged R files..."

  # Create temporary file list for lintr
  TEMP_FILE_LIST=$(mktemp)
  echo "$STAGED_R_FILES" > "$TEMP_FILE_LIST"

  # Run lintr
  LINTR_OUTPUT=$(Rscript -e "
    if (!requireNamespace('lintr', quietly = TRUE)) {
      cat('‚ö†Ô∏è  lintr package not installed. Installing...\\n')
      install.packages('lintr', repos='https://cloud.r-project.org', quiet=TRUE)
    }

    library(lintr)

    # Read file list
    files <- readLines('$TEMP_FILE_LIST')
    files <- files[nzchar(files)]  # Remove empty lines

    if (length(files) == 0) {
      cat('No files to lint\\n')
      quit(status = 0)
    }

    # Lint each file
    all_issues <- list()
    for (file in files) {
      if (file.exists(file)) {
        issues <- lint(file)
        if (length(issues) > 0) {
          all_issues[[file]] <- issues
        }
      }
    }

    # Report results
    if (length(all_issues) == 0) {
      cat('‚úÖ No linting issues found\\n')
      quit(status = 0)
    } else {
      cat('‚ùå Linting issues found:\\n\\n')
      for (file in names(all_issues)) {
        cat('File:', file, '\\n')
        print(all_issues[[file]])
        cat('\\n')
      }
      quit(status = 1)
    }
  " 2>&1)

  LINTR_EXIT_CODE=$?

  # Clean up temp file
  rm -f "$TEMP_FILE_LIST"

  # Check lintr results
  if [ $LINTR_EXIT_CODE -ne 0 ]; then
    echo -e "${RED}‚ùå Lintr checks failed${NC}"
    echo "$LINTR_OUTPUT"
    CHECKS_PASSED=false
  else
    echo -e "${GREEN}‚úÖ Lintr checks passed${NC}"
  fi

  # =============================================================================
  # 3. CHECK FOR SYNTAX ERRORS
  # =============================================================================
  echo ""
  echo "üîç Checking R syntax..."

  SYNTAX_ERRORS=false
  for file in $STAGED_R_FILES; do
    if [ -f "$file" ]; then
      # Check syntax
      Rscript -e "tryCatch({parse('$file'); cat('OK')}, error = function(e) {cat('ERROR:', conditionMessage(e)); quit(status=1)})" > /dev/null 2>&1
      if [ $? -ne 0 ]; then
        echo -e "${RED}‚ùå Syntax error in: $file${NC}"
        Rscript -e "tryCatch(parse('$file'), error = function(e) cat(conditionMessage(e)))"
        SYNTAX_ERRORS=true
      fi
    fi
  done

  if [ "$SYNTAX_ERRORS" = true ]; then
    CHECKS_PASSED=false
  else
    echo -e "${GREEN}‚úÖ No syntax errors found${NC}"
  fi
fi

# =============================================================================
# 4. RUN FAST TESTS (if test files exist)
# =============================================================================
echo ""
echo "üß™ Running fast tests..."

if [ -f "tests/test_runner.R" ]; then
  # Run fast test suite with timeout
  timeout 60 Rscript tests/test_runner.R > /dev/null 2>&1
  TEST_EXIT_CODE=$?

  if [ $TEST_EXIT_CODE -eq 124 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Tests timed out (>60s), skipping test check${NC}"
  elif [ $TEST_EXIT_CODE -ne 0 ]; then
    echo -e "${RED}‚ùå Fast tests failed${NC}"
    echo "   Run 'Rscript tests/test_runner.R' for details"
    CHECKS_PASSED=false
  else
    echo -e "${GREEN}‚úÖ Fast tests passed${NC}"
  fi
else
  echo "‚ÑπÔ∏è  No test_runner.R found, skipping tests"
fi

# =============================================================================
# 5. CHECK FOR COMMON ISSUES
# =============================================================================
echo ""
echo "üîé Checking for common issues..."

# Check for browser() debug statements
if git diff --cached | grep -E '^\+.*browser\(\)' > /dev/null 2>&1; then
  echo -e "${YELLOW}‚ö†Ô∏è  Found browser() debug statement(s) in staged changes${NC}"
  echo "   Remove debug statements or use --no-verify to bypass"
fi

# Check for large files (>5MB)
LARGE_FILES=$(git diff --cached --name-only --diff-filter=ACM | while read file; do
  if [ -f "$file" ]; then
    size=$(wc -c < "$file" 2>/dev/null || echo 0)
    if [ "$size" -gt 5242880 ]; then
      echo "$file ($size bytes)"
    fi
  fi
done)

if [ -n "$LARGE_FILES" ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  Large file(s) detected:${NC}"
  echo "$LARGE_FILES"
  echo "   Consider using Git LFS or .gitignore"
fi

# =============================================================================
# 6. FINAL RESULT
# =============================================================================
echo ""
echo "================================================"

if [ "$CHECKS_PASSED" = true ]; then
  echo -e "${GREEN}‚úÖ All pre-commit checks passed!${NC}"
  echo "================================================"
  exit 0
else
  echo -e "${RED}‚ùå Some checks failed${NC}"
  echo "================================================"
  echo ""
  echo "To bypass these checks (not recommended):"
  echo "  git commit --no-verify"
  echo ""
  echo "Or fix the issues and try again."
  exit 1
fi

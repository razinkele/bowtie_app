# =============================================================================
# Docker Compose Configuration for Environmental Bowtie Risk Analysis App
# Version: 5.4.0 (Stability & Infrastructure Edition)
# Updated: January 2026
# =============================================================================

version: '3.8'

services:
  # =============================================================================
  # PRODUCTION SERVICE
  # =============================================================================
  bowtie-app:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: production
    container_name: bowtie-app-prod
    ports:
      - "3838:3838"
    volumes:
      # Mount data directory for persistence
      - bowtie-data:/srv/shiny-server/bowtie_app/data
      - bowtie-logs:/var/log/shiny-server
    environment:
      - SHINY_ENV=production
      - TZ=Europe/Vilnius
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3838/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - bowtie-network
    labels:
      - "com.bowtie.version=5.4.0"
      - "com.bowtie.description=Environmental Bowtie Risk Analysis"

  # =============================================================================
  # DEVELOPMENT SERVICE
  # =============================================================================
  bowtie-app-dev:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: development
    container_name: bowtie-app-dev
    ports:
      - "3839:3838"
    volumes:
      # Mount entire app directory for hot reload
      - ..:/srv/shiny-server/bowtie_app
      - bowtie-dev-logs:/srv/shiny-server/bowtie_app/dev_logs
    environment:
      - SHINY_ENV=development
      - SHINY_HOST=0.0.0.0
      - SHINY_PORT=3838
      - TZ=Europe/Vilnius
    restart: "no"
    networks:
      - bowtie-network
    profiles:
      - dev

  # =============================================================================
  # TESTING SERVICE
  # =============================================================================
  bowtie-app-test:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: build
    container_name: bowtie-app-test
    volumes:
      - ./test_results:/srv/shiny-server/bowtie_app/test_results
      - ./performance_reports:/srv/shiny-server/bowtie_app/performance_reports
    environment:
      - SHINY_ENV=testing
      - TZ=Europe/Vilnius
    command: >
      sh -c "
      echo 'ðŸ§ª Running Comprehensive Test Suite' &&
      Rscript tests/comprehensive_test_runner.R &&
      echo 'ðŸ“Š Running Performance Benchmarks' &&
      Rscript utils/advanced_benchmarks.R &&
      echo 'âœ… All tests completed'
      "
    networks:
      - bowtie-network
    profiles:
      - test

  # =============================================================================
  # PERFORMANCE MONITORING SERVICE
  # =============================================================================
  performance-monitor:
    build:
      context: ..
      dockerfile: deployment/Dockerfile
      target: build
    container_name: bowtie-performance-monitor
    volumes:
      - ./performance_reports:/srv/shiny-server/bowtie_app/performance_reports
    environment:
      - SHINY_ENV=monitoring
      - TZ=Europe/Vilnius
    command: >
      sh -c "
      echo 'ðŸ“Š Starting Performance Monitoring' &&
      while true; do
        echo \"[$(date)] Running performance check...\" &&
        Rscript -e \"
          source('utils/performance_benchmark.R')
          results <- run_performance_suite()
          saveRDS(results, paste0('performance_reports/monitor_', format(Sys.time(), '%Y%m%d_%H%M%S'), '.rds'))
          cat('âœ… Performance check completed\n')
        \" &&
        sleep 3600
      done
      "
    networks:
      - bowtie-network
    profiles:
      - monitoring
    depends_on:
      - bowtie-app

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  bowtie-network:
    driver: bridge
    name: bowtie-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  bowtie-data:
    driver: local
    name: bowtie-app-data
  bowtie-logs:
    driver: local
    name: bowtie-app-logs
  bowtie-dev-logs:
    driver: local
    name: bowtie-app-dev-logs

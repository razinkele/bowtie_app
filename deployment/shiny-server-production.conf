# =============================================================================
# Shiny Server Production Configuration
# Environmental Bowtie Risk Analysis Application
# Version: 5.3.0 - November 2025
# =============================================================================
#
# This is an optimized production configuration for Shiny Server
# Place this file at: /etc/shiny-server/shiny-server.conf
#
# =============================================================================

# Run as shiny user (non-root for security)
run_as shiny;

# Server configuration
server {
  # Listen on port 3838 (standard Shiny Server port)
  listen 3838 0.0.0.0;

  # =========================================================================
  # Site-wide settings
  # =========================================================================

  # Root location for all apps
  location / {
    site_dir /srv/shiny-server;
    log_dir /var/log/shiny-server;
    directory_index on;
  }

  # =========================================================================
  # Bowtie App - Production Configuration
  # =========================================================================

  location /bowtie_app {
    # Application directory
    app_dir /srv/shiny-server/bowtie_app;

    # Dedicated log directory for this app
    log_dir /var/log/shiny-server/bowtie_app;

    # -----------------------------------------------------------------------
    # Timeout Settings (optimized for complex computations)
    # -----------------------------------------------------------------------

    # Maximum time for app to initialize (seconds)
    # Increased for Bayesian network loading
    app_init_timeout 180;

    # Maximum idle time before disconnecting (seconds)
    # Set to 1 hour for long analysis sessions
    app_idle_timeout 3600;

    # Connection timeout (seconds)
    # Time allowed for establishing connection
    connection_timeout 30;

    # Read timeout (seconds)
    # Maximum time to wait for data from R process
    read_timeout 600;

    # -----------------------------------------------------------------------
    # Session Management
    # -----------------------------------------------------------------------

    # Allow users to reconnect to existing sessions
    reconnect true;

    # Disable session timeouts (relies on app_idle_timeout instead)
    disable_websockets false;

    # -----------------------------------------------------------------------
    # Performance & Scaling
    # -----------------------------------------------------------------------

    # Use simple scheduler (multiple R processes)
    # Allows multiple concurrent users
    simple_scheduler 10;

    # Bookmark support for saving session state
    bookmark_state_dir /srv/shiny-server/bookmarks/bowtie_app;

    # -----------------------------------------------------------------------
    # Security
    # -----------------------------------------------------------------------

    # Disable directory indexing for this app
    directory_index off;

    # Sanitize error messages in production
    # Set to false for debugging
    sanitize_errors true;

    # -----------------------------------------------------------------------
    # Logging
    # -----------------------------------------------------------------------

    # Preserve logs after session ends
    preserve_logs true;

    # Log all R console output
    log_dir /var/log/shiny-server/bowtie_app;
  }
}

# =============================================================================
# Global Settings
# =============================================================================

# Access logging
access_log /var/log/shiny-server/access.log default;

# Error logging
error_log /var/log/shiny-server/error.log;

# Preserve logs for troubleshooting
preserve_logs true;

# Sanitize errors in production (hide R error details from users)
sanitize_errors true;

# =============================================================================
# Performance Tuning
# =============================================================================

# Maximum number of concurrent connections per app
# Adjust based on server resources
# Rule of thumb: (RAM in GB - 2) / 0.5 GB per user
# Example: 8GB RAM = (8-2)/0.5 = 12 users
simple_scheduler 15;

# =============================================================================
# Admin Panel (Optional - Comment out for security)
# =============================================================================

# Uncomment to enable admin panel at :4151
# admin 4151 {
#   required_user admin;
#   required_group shiny-admin;
# }

# =============================================================================
# Additional Applications (if needed)
# =============================================================================

# Example: Add more app locations here
# location /another_app {
#   app_dir /srv/shiny-server/another_app;
#   log_dir /var/log/shiny-server/another_app;
#   app_idle_timeout 900;
# }

# =============================================================================
# Notes
# =============================================================================
#
# After modifying this file:
#   sudo systemctl restart shiny-server
#
# Check configuration syntax:
#   shiny-server --test-config
#
# View logs:
#   tail -f /var/log/shiny-server/bowtie_app/*.log
#   journalctl -u shiny-server -f
#
# Monitor active sessions:
#   netstat -an | grep :3838 | wc -l
#
# =============================================================================

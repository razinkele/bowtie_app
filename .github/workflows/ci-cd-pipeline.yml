# =============================================================================
# Environmental Bowtie App - Advanced CI/CD Pipeline
# Version: 5.4.0 (Stability & Infrastructure Edition)
# Automated testing, performance monitoring, deployment, and AI code review
# =============================================================================

name: ğŸš€ Advanced CI/CD Pipeline

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run performance regression tests daily at 2 AM UTC
    - cron: '0 2 * * *'

# Ensure CodeRabbit has necessary permissions
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # =============================================================================
  # CONSISTENCY AND QUALITY CHECKS
  # =============================================================================
  consistency-checks:
    name: ğŸ” Consistency & Quality Validation
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup R Environment
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: ğŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev

    - name: ğŸ“‹ Cache R Packages
      uses: actions/cache@v3
      with:
        path: ~/.local/share/renv
        key: ${{ runner.os }}-renv-${{ hashFiles('**/renv.lock') }}
        restore-keys: |
          ${{ runner.os }}-renv-

    - name: ğŸ” Install R Dependencies
      run: |
        Rscript -e "install.packages(c('testthat', 'microbenchmark', 'dplyr', 'stringr', 'readxl', 'openxlsx', 'shiny', 'DT', 'ggplot2', 'plotly', 'visNetwork'))"

    - name: âœ… Run Consistency Tests
      run: |
        Rscript -e "
        library(testthat)
        # Run consistency validation tests
        test_results <- test_dir('tests/testthat/',
                                filter = 'consistency',
                                reporter = 'summary')
        if (any(test_results[['failed']] > 0)) {
          stop('Consistency tests failed')
        }
        "

    - name: ğŸ¨ Validate Icon Standardization
      run: |
        Rscript -e "
        # Check for mixed icon usage (case-sensitive filenames for Linux)
        files <- c('ui.R', 'server.R', 'guided_workflow.R')
        issues <- 0
        for (file in files[file.exists(files)]) {
          content <- readLines(file)
          if (any(grepl('tags\\\$i\\\(class = \"fas', content))) {
            cat('âŒ Mixed icon usage found in', file, '\n')
            issues <- issues + 1
          }
        }
        if (issues > 0) stop('Icon standardization issues detected')
        cat('âœ… Icon usage is consistent across all files\n')
        "

    - name: ğŸ”— Validate Dependency Structure
      run: |
        Rscript -e "
        # Check for circular dependencies (case-sensitive filenames for Linux)
        if (file.exists('guided_workflow.R')) {
          content <- readLines('guided_workflow.R')
          if (any(grepl('source\\\\(\"guided_workflow\\\\.R\"\\\\)', content, ignore.case = TRUE))) {
            stop('âŒ Circular dependency detected in guided_workflow.R (self-reference)')
          }
        }
        cat('âœ… No circular dependencies detected\n')
        "

  # =============================================================================
  # COMPREHENSIVE TESTING SUITE
  # =============================================================================
  comprehensive-testing:
    name: ğŸ§ª Comprehensive Testing Suite
    runs-on: ubuntu-latest
    needs: consistency-checks

    strategy:
      matrix:
        r-version: ['4.3.2', '4.4.3']

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup R Environment
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: ${{ matrix.r-version }}

    - name: ğŸ“¦ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev
        Rscript -e "install.packages(c('testthat', 'shiny', 'DT', 'readxl', 'openxlsx', 'ggplot2', 'plotly', 'dplyr', 'visNetwork', 'shinycssloaders', 'colourpicker', 'htmlwidgets', 'shinyjs', 'bslib', 'microbenchmark'))"

    - name: ğŸ§ª Run Test Suite
      run: |
        Rscript tests/comprehensive_test_runner.R

    - name: ğŸ“Š Generate Test Coverage Report
      run: |
        Rscript -e "
        library(testthat)
        # Run all tests with coverage
        test_results <- test_dir('tests/testthat/', reporter = 'summary')

        # Save results for analysis
        saveRDS(test_results, 'test_results.rds')

        # Print summary
        cat('âœ… Test execution completed\n')
        cat('Total tests:', sum(test_results[['nb']]), '\n')
        cat('Passed:', sum(test_results[['nb']] - test_results[['failed']]), '\n')
        cat('Failed:', sum(test_results[['failed']]), '\n')
        "

    - name: ğŸ“¤ Upload Test Results
      uses: actions/upload-artifact@v3
      with:
        name: test-results-r${{ matrix.r-version }}
        path: |
          test_results.rds
          tests/

  # =============================================================================
  # PERFORMANCE REGRESSION TESTING
  # =============================================================================
  performance-testing:
    name: ğŸ“ˆ Performance Regression Testing
    runs-on: ubuntu-latest
    needs: consistency-checks

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup R Environment
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: ğŸ“¦ Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libcurl4-openssl-dev libxml2-dev libssl-dev
        Rscript -e "install.packages(c('microbenchmark', 'pryr', 'jsonlite', 'shiny', 'DT', 'readxl', 'openxlsx', 'ggplot2', 'dplyr', 'bslib', 'htmltools'))"

    - name: ğŸ“Š Run Performance Benchmarks
      run: |
        Rscript -e "
        # Source performance testing utilities
        source('utils/advanced_benchmarks.R')

        # Run complete performance suite
        results <- run_complete_performance_suite()

        # Save results
        saveRDS(results, 'performance_results.rds')

        cat('âœ… Performance testing completed\n')
        "

    - name: ğŸ“¤ Upload Performance Results
      uses: actions/upload-artifact@v3
      with:
        name: performance-results
        path: |
          performance_results.rds
          performance_reports/
          utils/performance_baseline.json

  # =============================================================================
  # SECURITY AND QUALITY ANALYSIS
  # =============================================================================
  security-analysis:
    name: ğŸ›¡ï¸ Security & Quality Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup R Environment
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: ğŸ” R Package Security Scan
      run: |
        Rscript -e "
        # Check for known vulnerabilities in dependencies
        installed_packages <- rownames(installed.packages())
        cat('ğŸ“¦ Installed packages:', length(installed_packages), '\n')

        # Basic security checks
        sensitive_patterns <- c('password', 'secret', 'key', 'token', 'credential')
        r_files <- list.files('.', pattern = '\\\\.r$|\\\\.R$', recursive = TRUE)

        for (file in r_files) {
          content <- paste(readLines(file, warn = FALSE), collapse = ' ')
          for (pattern in sensitive_patterns) {
            if (grepl(pattern, content, ignore.case = TRUE)) {
              cat('âš ï¸  Potential sensitive data in', file, ':', pattern, '\n')
            }
          }
        }

        cat('ğŸ›¡ï¸ Security scan completed\n')
        "

    - name: ğŸ“‹ Code Quality Analysis
      run: |
        Rscript -e "
        # Check code quality metrics
        r_files <- list.files('.', pattern = '\\\\.r$|\\\\.R$', recursive = TRUE, full.names = TRUE)

        total_lines <- 0
        total_files <- 0

        for (file in r_files) {
          lines <- length(readLines(file, warn = FALSE))
          total_lines <- total_lines + lines
          total_files <- total_files + 1

          if (lines > 1000) {
            cat('ğŸ“ Large file detected:', file, '(', lines, 'lines)\n')
          }
        }

        avg_lines_per_file <- round(total_lines / total_files)

        cat('ğŸ“Š Code Quality Metrics:\n')
        cat('  Total files:', total_files, '\n')
        cat('  Total lines:', total_lines, '\n')
        cat('  Average lines per file:', avg_lines_per_file, '\n')
        "

  # =============================================================================
  # DEPLOYMENT PREPARATION
  # =============================================================================
  deployment-preparation:
    name: ğŸš€ Deployment Preparation
    runs-on: ubuntu-latest
    needs: [comprehensive-testing, performance-testing]
    if: github.ref == 'refs/heads/main'

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup R Environment
      uses: r-lib/actions/setup-r@v2
      with:
        r-version: '4.4.3'

    - name: ğŸ“¦ Create Deployment Package
      run: |
        # Create deployment directory
        mkdir -p deployment_package

        # Copy essential files
        cp -r *.r *.R deployment_package/ 2>/dev/null || true
        cp -r *.xlsx deployment_package/ 2>/dev/null || true
        cp -r www/ deployment_package/ 2>/dev/null || true
        cp README.md CLAUDE.md deployment_package/ 2>/dev/null || true

        # Create deployment info
        echo "Deployment Package - Version 5.4.0" > deployment_package/DEPLOYMENT_INFO.txt
        echo "Built on: $(date)" >> deployment_package/DEPLOYMENT_INFO.txt
        echo "Git commit: ${{ github.sha }}" >> deployment_package/DEPLOYMENT_INFO.txt
        echo "Branch: ${{ github.ref_name }}" >> deployment_package/DEPLOYMENT_INFO.txt

        # Create deployment script
        cat > deployment_package/deploy.sh << 'EOF'
        #!/bin/bash
        echo "ğŸš€ Deploying Environmental Bowtie Risk Analysis Application"
        echo "Version: 5.4.0 (Stability & Infrastructure Edition)"

        # Install R dependencies
        Rscript -e "
        required_packages <- c('shiny', 'bslib', 'DT', 'readxl', 'openxlsx',
                              'ggplot2', 'plotly', 'dplyr', 'visNetwork',
                              'shinycssloaders', 'colourpicker', 'htmlwidgets', 'shinyjs')

        for (pkg in required_packages) {
          if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
            install.packages(pkg, dependencies = TRUE)
          }
        }
        "

        # Start application
        echo "ğŸŒ Starting application on http://0.0.0.0:3838"
        Rscript start_app.R
        EOF

        chmod +x deployment_package/deploy.sh

        echo "ğŸ“¦ Deployment package created successfully"

    - name: ğŸ“¤ Upload Deployment Package
      uses: actions/upload-artifact@v3
      with:
        name: deployment-package-v5.4.0
        path: deployment_package/

    - name: ğŸ“‹ Deployment Summary
      run: |
        echo "ğŸ‰ Deployment preparation completed successfully!"
        echo "âœ… All tests passed"
        echo "âœ… Performance benchmarks completed"
        echo "âœ… Security analysis passed"
        echo "âœ… Deployment package ready"
        echo ""
        echo "ğŸ“¦ Deployment package includes:"
        ls -la deployment_package/

  # =============================================================================
  # CODERABBIT AI CODE REVIEW INTEGRATION
  # =============================================================================
  coderabbit-check:
    name: ğŸ¤– CodeRabbit AI Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ¤– CodeRabbit Status Check
      run: |
        echo "ğŸ¤– CodeRabbit AI Code Review Integration"
        echo "========================================"
        echo ""
        echo "CodeRabbit will automatically review this PR and provide:"
        echo "  âœ… Inline code suggestions"
        echo "  âœ… Security vulnerability detection"
        echo "  âœ… Performance optimization recommendations"
        echo "  âœ… R/Shiny best practices validation"
        echo "  âœ… Test coverage analysis"
        echo ""
        echo "Configuration: .coderabbit.yaml"
        echo "Documentation: .github/CODERABBIT.md"
        echo ""
        echo "To interact with CodeRabbit, use:"
        echo "  @coderabbitai review - Request a review"
        echo "  @coderabbitai apply - Apply suggested fixes"
        echo "  @coderabbitai explain - Get clarification"
        echo ""
        echo "â³ CodeRabbit review will appear within 1-2 minutes..."

    - name: ğŸ“‹ Verify CodeRabbit Configuration
      run: |
        if [ -f ".coderabbit.yaml" ]; then
          echo "âœ… CodeRabbit configuration found"
          echo ""
          echo "Configuration summary:"
          echo "  - Review level: comprehensive"
          echo "  - Language: R (Shiny)"
          echo "  - Auto-fix: enabled"
          echo "  - Coverage threshold: 80%"
          echo "  - Custom rules: enabled"
        else
          echo "âš ï¸  CodeRabbit configuration not found"
          echo "Expected file: .coderabbit.yaml"
          exit 1
        fi

  # =============================================================================
  # NOTIFICATION AND REPORTING
  # =============================================================================
  notification:
    name: ğŸ“¢ Pipeline Notifications
    runs-on: ubuntu-latest
    needs: [comprehensive-testing, performance-testing, security-analysis]
    if: always()

    steps:
    - name: ğŸ“Š Pipeline Summary
      run: |
        echo "ğŸ” CI/CD Pipeline Summary"
        echo "=========================="
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref_name }}"
        echo "Commit: ${{ github.sha }}"
        echo "Triggered by: ${{ github.event_name }}"
        echo ""
        echo "Job Status:"
        echo "- Comprehensive Testing: ${{ needs.comprehensive-testing.result || 'skipped' }}"
        echo "- Performance Testing: ${{ needs.performance-testing.result || 'skipped' }}"
        echo "- Security Analysis: ${{ needs.security-analysis.result || 'skipped' }}"
        echo ""
        if [[ "${{ needs.comprehensive-testing.result }}" == "success" && "${{ needs.performance-testing.result }}" == "success" ]]; then
          echo "âœ… All critical jobs completed successfully!"
        else
          echo "âŒ Some jobs failed or were skipped"
        fi